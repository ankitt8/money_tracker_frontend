name: Pull Request Checks

on:
  pull_request:
    branches: [master]
    types:
      - 'opened'
      - 'edited'
      - 'synchronize'
      - 'reopened'

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch pr body and check if mandatory checkboxes are checked
        id: fetch-pr
        run: |
          PR_DETAILS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}")

          if [ -z "${PR_DETAILS}" ]; then
            echo "Failed to fetch PR details."
            exit 1
          else
            echo "Fetched PR Details:"
          #  echo "${PR_DETAILS}"
          fi

          # Extract the body from PR_DETAILS and store it in a variable
          PR_BODY=$(echo "$PR_DETAILS" | jq -r .body)
          # echo "PR_BODY=${PR_BODY}"
          
          unchecked_checkboxes=()
          checkboxes=("Tested the code locally" "Not added any image locally")
  
          for checkbox in "${checkboxes[@]}"; do
            if ! echo "$PR_BODY" | grep -q "\- \[x\] $checkbox"; then
              unchecked_checkboxes+=("$checkbox")
              break
            fi
          done
          
          
          
          if [ ${#unchecked_checkboxes[@]} -eq 0 ]; then
            echo "All required checkboxes are checked. Proceeding..."
          else
            echo "Below required checkboxes are not checked. Please update the PR body:"
            for unchecked_checkbox in "${unchecked_checkboxes[@]}"; do
              echo "- $unchecked_checkbox is not checked."
            done
            exit 1
          fi
